name: Run api-proctor tests
description: Run the api-proctor tests for a backend service repo
inputs:
  gha-dev-key:
    description: The GHA_DEV_KEY secret
    required: true
  dev-aws-credentials:
    description: The DEV_AWS_CREDENTIALS secret
    required: true
runs:
  using: composite
  steps:
    - name: Checkout development repo
      uses: actions/checkout@v2
      with:
        repository: nicheinc/development
        ref: 'ci'
        ssh-key: ${{ inputs.gha-dev-key }}

    - name: Create docker-compose override and AWS credentials files
      env:
        ENCODED_CREDENTIALS: ${{ inputs.dev-aws-credentials }}
      shell: bash
      run: |
        sed -i 's/\${REGISTRY}\/${{ matrix.service }}:v[[:digit:]]\+.[[:digit:]]\+.[[:digit:]]\+/${{ matrix.service }}:latest/g' \
          docker-compose.ci.yaml
        echo $ENCODED_CREDENTIALS | base64 -di > vault/aws_credentials

    - name: Launch service with dependencies in docker-compose
      env:
        REGISTRY: ${{ steps.login-ecr.outputs.registry }}
      shell: bash
      run: |
        docker-compose -f docker-compose.yaml -f docker-compose.ci.yaml up -d ${{ matrix.service }}

    - name: api-proctor health check test
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
      shell: bash
      run: |
        docker run \
          --rm \
          --name api-proctor \
          --network host \
          $ECR_REGISTRY/api-proctor:${{ env.API_PROCTOR_VERSION }} \
          ${{ matrix.service }}/health.get --testPathIgnorePatterns=/src/ --passWithNoTests

    - name: Docker Compose logs
      shell: bash
      run: |
        echo "::group::Docker ${{ matrix.service }} logs"
        echo "--- Kafka logs ---"
        docker-compose logs kafka || echo "Kafka not running"
        echo "--- Postgres logs ---"
        docker-compose logs postgres || echo "Postgres not running"
        echo "--- ${{ matrix.service }} logs ---"
        docker-compose logs ${{ matrix.service }}
        echo "::endgroup::"
